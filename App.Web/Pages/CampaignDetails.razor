@page "/campaigns/{CampaignId:guid}"
@inject CampaignService CampaignService
@inject PostService PostService
@inject TenantState TenantState
@inject NavigationManager Navigation

<PageTitle>Campaign</PageTitle>

@if (!IsTenantSelected)
{
    <div class="alert alert-info">Select a tenant to manage campaigns.</div>
}
else if (Campaign == null)
{
    <div class="alert alert-warning">Campaign not found.</div>
}
else
{
    <h1>@Campaign.Name</h1>
    <p>@Campaign.Description</p>

    <div class="row">
        <div class="col-md-6">
            <h4>Items</h4>
            <EditForm Model="this" OnValidSubmit="AddItems">
                <div class="mb-3">
                    <label class="form-label">Paste items (one per line)</label>
                    <InputTextArea class="form-control" @bind-Value="ItemsInput" rows="6" />
                </div>
                <button class="btn btn-primary" type="submit">Add items</button>
            </EditForm>

            <table class="table table-sm mt-3">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Text</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Items)
                    {
                        <tr>
                            <td>@item.OrderIndex</td>
                            <td>@item.SourceText</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <h4>Posts</h4>
            <button class="btn btn-outline-primary mb-2" @onclick="GenerateCreatedPosts">Generate for new posts</button>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Post</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var post in Posts)
                    {
                        <tr>
                            <td>@post.Id</td>
                            <td>@post.Status</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenPost(post)">Open</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    [Parameter] public Guid CampaignId { get; set; }

    private bool IsTenantSelected => !string.IsNullOrWhiteSpace(TenantState.TenantId);
    private Campaign? Campaign { get; set; }
    private List<Item> Items { get; set; } = new();
    private List<Post> Posts { get; set; } = new();
    private string ItemsInput { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (!IsTenantSelected)
        {
            Navigation.NavigateTo("/tenants");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        Campaign = await CampaignService.GetCampaignAsync(TenantState.TenantId!, CampaignId, CancellationToken.None);
        Items = await CampaignService.GetItemsAsync(TenantState.TenantId!, CampaignId, CancellationToken.None);
        Posts = await PostService.GetPostsAsync(TenantState.TenantId!, CampaignId, null, CancellationToken.None);
    }

    private async Task AddItems()
    {
        await CampaignService.AddItemsAsync(TenantState.TenantId!, CampaignId, ItemsInput, CancellationToken.None);
        ItemsInput = string.Empty;
        await LoadData();
    }

    private async Task GenerateCreatedPosts()
    {
        var createdPosts = Posts.Where(post => post.Status == PostStatus.Created).ToList();
        foreach (var post in createdPosts)
        {
            await PostService.GenerateAsync(TenantState.TenantId!, post.Id, CancellationToken.None);
        }

        await LoadData();
    }

    private void OpenPost(Post post)
    {
        Navigation.NavigateTo($"/posts/{post.Id}");
    }
}
