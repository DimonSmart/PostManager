@page "/campaigns"
@using Microsoft.AspNetCore.WebUtilities
@inject CampaignService CampaignService
@inject TenantState TenantState
@inject CampaignScheduler CampaignScheduler
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>Campaigns</PageTitle>

@if (!IsTenantSelected)
{
    <MudAlert Severity="Severity.Info">Select a tenant to manage campaigns.</MudAlert>
}
else
{
    <MudStack Spacing="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h4">Campaigns</MudText>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Href="/campaigns/new">
                Create
            </MudButton>
        </MudStack>

        <MudPaper Class="pa-4">
            <MudTable Items="CampaignList" Hover="true" Dense="true" Bordered="true" RowClassFunc="RowClassFunc">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Moderation</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate Context="campaign">
                    <MudTd DataLabel="Name">@campaign.Name</MudTd>
                    <MudTd DataLabel="Moderation">@(campaign.RequiresModeration ? "Manual" : "Auto")</MudTd>
                    <MudTd>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="() => EditCampaign(campaign.Id)">Edit</MudButton>
                        <MudButton Variant="Variant.Text" Size="Size.Small" Class="ms-2" OnClick="() => OpenCampaign(campaign)">Open</MudButton>
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Error" Class="ms-2" OnClick="() => ConfirmDelete(campaign)">Delete</MudButton>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No campaigns yet.</MudText>
                </NoRecordsContent>
            </MudTable>
        </MudPaper>
    </MudStack>
}

@code {
    private bool IsTenantSelected => !string.IsNullOrWhiteSpace(TenantState.TenantId);
    private List<Campaign> CampaignList { get; set; } = new();
    private Guid? SelectedCampaignId { get; set; }
    private bool HasScrolled { get; set; }
    private bool SnackbarShown { get; set; }
    private bool ShouldScroll { get; set; }

    protected override void OnParametersSet()
    {
        ReadSelectedIdFromQuery();
    }

    protected override async Task OnInitializedAsync()
    {
        if (!IsTenantSelected)
        {
            Navigation.NavigateTo("/tenants");
            return;
        }

        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (ShouldScroll && !HasScrolled)
        {
            HasScrolled = true;
            await JSRuntime.InvokeVoidAsync("postManager.scrollToSelector", ".pm-selected-row");
        }
    }

    private async Task LoadData()
    {
        CampaignList = await CampaignService.GetCampaignsAsync(TenantState.TenantId!, CancellationToken.None);
        UpdateSelectedRow();
    }

    private void ReadSelectedIdFromQuery()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("selectedId", out var values) && Guid.TryParse(values.FirstOrDefault(), out var id))
        {
            if (SelectedCampaignId != id)
            {
                HasScrolled = false;
                SnackbarShown = false;
            }

            SelectedCampaignId = id;
        }
        else
        {
            SelectedCampaignId = null;
            ShouldScroll = false;
        }
    }

    private void UpdateSelectedRow()
    {
        if (!SelectedCampaignId.HasValue)
        {
            ShouldScroll = false;
            return;
        }

        var match = CampaignList.FirstOrDefault(campaign => campaign.Id == SelectedCampaignId.Value);
        if (match == null)
        {
            ShouldScroll = false;
            return;
        }

        ShouldScroll = true;
        if (!SnackbarShown)
        {
            SnackbarShown = true;
            Snackbar.Add("Created", Severity.Success);
        }
    }

    private string RowClassFunc(Campaign campaign, int rowNumber)
    {
        return SelectedCampaignId.HasValue && campaign.Id == SelectedCampaignId.Value
            ? "pm-selected-row"
            : string.Empty;
    }

    private void EditCampaign(Guid campaignId)
    {
        Navigation.NavigateTo($"/campaigns/{campaignId}");
    }

    private void OpenCampaign(Campaign campaign)
    {
        Navigation.NavigateTo($"/campaigns/{campaign.Id}/details");
    }

    private async Task ConfirmDelete(Campaign campaign)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete campaign",
            $"Delete '{campaign.Name}'? This removes posts and items too.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed != true)
        {
            return;
        }

        await CampaignService.DeleteCampaignAsync(TenantState.TenantId!, campaign.Id, CancellationToken.None);
        await CampaignScheduler.UnscheduleCampaignAsync(campaign.Id, CancellationToken.None);
        Snackbar.Add("Deleted", Severity.Success);
        await LoadData();
    }
}
